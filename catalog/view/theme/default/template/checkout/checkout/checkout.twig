{{ header }}
{% if error_warning %}
  <div class="alert alert-danger"><i class="fa fa-exclamation-circle"></i> {{ error_warning }}
    <button type="button" class="close" data-dismiss="alert">&times;</button>
  </div>
{% endif %}
<input data-html="checkout_confirmation_worldpay" type="hidden" />
<div class="indexHomeBody index_checkout_body">
  <div class="pay-head">
    <div class="container-fluid checkout-header" style="margin-bottom: 10px;">
      <a class="logo-check iconfont shein-icon" href="index.php" title=""> <i class="iconfont"></i> </a>
      <span class="checkout-header-title"> <i class="iconfont secure-icon"></i> {{ heading_title }} </span>
    </div>
  </div>
  <div class="container-fluid mbag-step3">
    <ul class="flow  shoppingTitle_f">
      <li class="step1"><a href="index.php">Home</a></li>
      <li class="step2"><a href="index.php?route=checkout/cart">Orders</a></li>
      <li class="step3"><a href="/">{{ heading_title }}</a></li>
      <li class="step4">Order Complete</li>
    </ul>
    <div class="shopbag-details row ">
      <div class="left-ctn col-md-8 col-xs-8">
        <div class="pay-back">
          <i class="iconfont"></i>
          <a href="index.php?route=checkout/cart">Back to Place Order Page</a>
        </div>

      {#地址栏#}
        <div class="bill-ads">
          <div class="heading">
            <h2 class="she-h1"> Billing Address </h2>
            <span> Please make sure the billing address you enter below matches the name and address associated with the credit card you are using for this purchase. </span>
          </div>
            <div class="ads" id="billing_address_2">
                <div id="new_billing_address">
                    <div class="left-section-wrapper">
                        {{ shipping_address_section }}
                    </div>
                </div>
                {#<a id="pay-edit" class="she-text-btn-light" href="javascript:void(0)"> edit </a>#}
            </div>
        </div>
      {#地址栏#}

      {#银行卡#}
        <div class="credit">
          <input value="2" class="is_bind" type="hidden" />
          <div class="heading">
            <h2 class="she-h1"> Credit And Debit Card Information <i class="iconfont" style="font-size: 16px;"></i> </h2>
          </div>
          <div class="confirm_masked" id="confirm_masked_2">
          </div>
          <form class="list-unit" action="#">
            <input value="2" class="is_bind" type="hidden" />
            <div class="remember-menu" style="display: none;">
              <div class="remember_old item">
                <div class="remember-old-card">
                  Use Current Card
                </div>
              </div>
              <div class="remember_add item">
                <div class="remember-old-card">
                  Use A New Card
                </div>
              </div>
              <br class="clear" />
            </div>
            <div class="inf remember_old_card" style="display: none;">
              <div class="card-num list-item card-radioed">
              </div>
              <div class="sec-cod list-item">
                <div class="item-title">
                  <span class="undone"> Security code: <span>*</span> </span>
                </div>
                <input id="card_cvc" class="ckout-card-input" name="card_cvn" placeholder="CVV/CVC/CID" maxlength="4" autocomplete="off" onclick="javascript:$('#card_cvc_error').hide();" value="" type="text" />
                <a class="she-text-btn-light pay-code" onclick="javascript:$('#divCVVHelp').show();"> What is a security code? </a>
                <div id="card_cvc_error" style="display: none;">
                  <span class="card-input-error"></span>
                </div>
              </div>
            </div>
            <div class="inf remember_add_card">
              <div class="confirm-label-bg" style="display: none;">
                <div class="confirm-loading-p" style="display: none;">
                  Payment details:
                </div>
              </div>
              <ul class="confirm_method_img">
                <li class="card_visa"></li>
                <li class="card_master"></li>
                <li class="card_mae"></li>
                <li class="card_ame"></li>
              </ul>
              <div id="confirm_loading_table">
                <div class="card-num list-item" style="position: relative;">
                  <div class="item-title">
                    <span class="undone">Card No.<span>*</span></span>
                  </div>
                  <input id="card_number" class="ckout-card-input j-card-number" name="card_number" maxlength="24" autocomplete="off" onclick="javascript:$('#card_number_error').hide();" value="" type="text" />
                  <div id="card_number_error" style="display: none;">
                    <span class="card-input-error"></span>
                  </div>
                </div>
                <div class="list-item">
                  <div class="drop mon">
                    <div class="item-title">
                      <span class="undone">Expiration date</span>
                      <span>*</span>
                    </div>
                    <select id="card_exp_month" class="card_exp_time" name="card_exp_month"> <option value="-1"> Month </option> <option value="01">01</option><option value="02">02</option><option value="03">03</option><option value="04">04</option><option value="05">05</option><option value="06">06</option><option value="07">07</option><option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option></select>
                  </div>
                  <div class="drop year">
                    <select id="card_exp_year" class="card_exp_time" name="card_exp_year"> <option value="-1"> Year </option> <option value="2018">2018</option><option value="2019">2019</option><option value="2020">2020</option><option value="2021">2021</option><option value="2022">2022</option><option value="2023">2023</option><option value="2024">2024</option><option value="2025">2025</option><option value="2026">2026</option><option value="2027">2027</option><option value="2028">2028</option><option value="2029">2029</option><option value="2030">2030</option><option value="2031">2031</option><option value="2032">2032</option><option value="2033">2033</option><option value="2034">2034</option><option value="2035">2035</option><option value="2036">2036</option><option value="2037">2037</option><option value="2038">2038</option><option value="2039">2039</option><option value="2040">2040</option><option value="2041">2041</option><option value="2042">2042</option><option value="2043">2043</option><option value="2044">2044</option></select>
                  </div>
                  <div id="expiration_date_error" style="display: none;">
                    <span class="card-input-error"></span>
                  </div>
                </div>
                <div class="sec-cod list-item">
                  <div class="item-title">
                    <span class="undone j-security-code"> Security code <span>*</span> </span>
                  </div>
                  <input id="card_cvn" class="ckout-card-input" name="card_cvn" placeholder="CVV/CVC/CID" maxlength="4" autocomplete="off" onclick="javascript:$('#card_cvn_error').hide();" value="" type="text" />
                  <a class="she-text-btn-light pay-code" onclick="javascript:$('#divCVVHelp').show();"> What is a security code? </a>
                  <div id="card_cvn_error" style="display: none;">
                    <span class="card-input-error"></span>
                  </div>
                </div>
              </div>
              <div class="rem-ctn" style="display: none;">
                <input class="she-check" id="remember_card" value="1" type="checkbox" />
                <span>Remember this card for later use</span>
              </div>
            </div>
          </form>
        </div>
      {#银行卡#}

      </div>

    {#右边栏#}
      <div class="right-ctn col-md-4 col-xs-4">
        <div class="order-summary">
            <div>
                {{ cart_section }}
            </div>

          <p>Additional payment security with:</p>
          <span class="payment-secure"></span>
          <input id="button-submit" class="she-btn-black she-btn-xl mar-top-20" value="{{ text_checkout_confirm }}"  data-loading-text="{{ text_loading }}" class="btn btn-primary btn-block" />
          <p class="card-local-promt" style="display: none;"> Please click the button and continue payment </p>
          <div id="payment_error" style="display: none;">
            <span class="card-input-error"></span>
          </div>
        </div>
      </div>
    {#右边栏#}

    </div>
  </div>

{#安全码弹窗#}
  <div id="divCVVHelp" class="cvv_help" style="display: none;">
    <div class="cvv_help_bg"></div>
    <div class="cvv_help_title">
      <a class="cvv_help_close" onclick="javascript:$('#divCVVHelp').hide();"></a>
      <table width="100%" cellspacing="0" cellpadding="0" border="0">
        <tbody>
        <tr>
          <td width="99%"></td>
        </tr>
        <tr>
          <td> <h5>Information on Security Code</h5> </td>
        </tr>
        <tr>
          <td> <p style="word-break: break-all;">We require that you enter your credit card verification number (CVV) to make sure the payment goes through. Your CVV number can be located on the back of your credit card.</p> </td>
        </tr>
        <tr>
          <td style="text-align: center;"> <img src="/catalog/view/theme/default/image/checkout/creditcard.jpg" border="0" /> </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
{#安全码弹窗#}

</div>

<script type="text/javascript"><!--
    {% if shipping_required %}
    // Shipping address change
    $('#shipping-address-section').on('change', function() {
        save_shipping_address();
    });

    $('#shipping-address-section select[name=\'shipping_address_id\']').on('change', function() {
        change_existing_address_id('shipping');
    });

    // Shipping address new or existing address toggle
    $('#shipping-address-section input[name=\'shipping_address\']').on('change', function() {
        if ($(this).val() == 'new') {
            save_shipping_address();
        } else {
            change_existing_address_id('shipping');
        }
    });
    {% endif %}

    // Payment method changed
    $(document).delegate('#payment-method-section input[type=\'radio\']', 'change', function() {
        save_payment_method();
    });

    // Payment method changed
    $(document).delegate('#shipping-method-section input[type=\'radio\']', 'change', function() {
        save_shipping_method();
    });

    // Comment changed
    $(document).delegate('#comment-section textarea[name=\'comment\']', 'change', function() {
        save_comment();
    });

    // Agreement changed
    $(document).delegate('#agree-section input[name=\'terms\']', 'change', function() {
        save_agreement();
    });

    // Submit button clicked
    $(document).delegate('#button-submit', 'click', function () {
        submit();
    });

    {% if shipping_required %}
    function save_shipping_address() {
        $.ajax({
            url: 'index.php?route=checkout/checkout/update',
            type: 'post',
            data: $('#shipping-address-section input[type=\'text\'], #shipping-address-section input[type=\'date\'], #shipping-address-section input[type=\'datetime-local\'], #shipping-address-section input[type=\'time\'], #shipping-address-section input[type=\'password\'], #shipping-address-section input[type=\'checkbox\']:checked, #shipping-address-section input[type=\'radio\']:checked, #shipping-address-section textarea, #shipping-address-section select'),
            dataType: 'json',
            beforeSend: function() {
                $('#shipping-address-section .alert-danger').remove();
            },
            success: function(json) {
                if (json['redirect']) {
                    location = json['redirect'];
                    return;
                }

                if (json['error'] && json['error']['warning']) {
                    $('#shipping-address-section').append('<div class="alert alert-danger">' + json['error']['warning'] + '</div>')
                    return;
                }

                reload_right_section_html();
            },
            error: function(xhr, ajaxOptions, thrownError) {
            }
        });
    }

    function change_existing_address_id(type) {
        $.ajax({
            url: 'index.php?route=checkout/checkout/update',
            type: 'post',
            data: $('#' + type + '-address-section select[name=\'' + type + '_address_id\']'),
            dataType: 'json',
            beforeSend: function() {
                // TODO
            },
            success: function(json) {
                if (json['redirect']) {
                    location = json['redirect'];
                    return;
                }

                reload_right_section_html();
            },
            error: function(xhr, ajaxOptions, thrownError) {
            }
        });
    }
    {% endif %}

    // Payment method & shipping method
    {% set types = (shipping_required ? ['payment', 'shipping'] : ['payment']) %}
    {% for type in types %}
    function save_{{ type }}_method() {
        $.ajax({
            url: 'index.php?route=checkout/checkout/update',
            type: 'post',
            data: $('#{{ type }}-method-section input[type=\'radio\']:checked'),
            dataType: 'json',
            beforeSend: function() {
                $('.container .alert-danger').remove();
                $('#{{ type }}-method-section .alert-danger').remove();
            },
            success: function(json) {
                if (json['redirect']) {
                    location = json['redirect'];
                }

                if (json['error'] && json['error']['warning']) {
                    $('#{{ type }}-method-section').append('<div class="alert alert-danger">' + json['error']['warning'] + '</div>')
                }

                reload_right_section_html();
            },
            error: function(xhr, ajaxOptions, thrownError) {
                alert(thrownError);
            }
        });
    }
    {% endfor %}

    function save_comment() {
        $.ajax({
            url: 'index.php?route=checkout/checkout/update',
            type: 'post',
            data: $('#comment-section textarea[name=\'comment\']'),
            dataType: 'json',
            beforeSend: function() {
                // TODO
            },
            success: function(json) {
                reload_right_section_html();
            },
            error: function(xhr, ajaxOptions, thrownError) {
            }
        });
    }

    function save_agreement() {
        $.ajax({
            url: 'index.php?route=checkout/checkout/update',
            type: 'post',
            data: {terms: $('#agree-section input[name=\'terms\']').prop('checked') ? 1 : 0},
            dataType: 'json',
            beforeSend: function() {
                // TODO
            },
            success: function(json) {
                reload_right_section_html();
            },
            error: function(xhr, ajaxOptions, thrownError) {
            }
        });
    }

    function submit() {
        var data = {};
        {% if not logged %}
        data['account'] = account_type;
        {% endif %}
        $('.quick-checkout-wrapper input[type="text"], .quick-checkout-wrapper input[type="password"], .quick-checkout-wrapper select, .quick-checkout-wrapper input:checked, .quick-checkout-wrapper textarea[name="comment"]').each(function () {
            data[$(this).attr('name')] = $(this).val();
        });

        $.ajax({
            url: 'index.php?route=checkout/checkout/confirm',
            type: 'post',
            data: data,
            dataType: 'json',
            beforeSend: function() {
                $('.form-group').removeClass('has-error');
                $('.alert-danger').remove();
                $('.text-danger').remove();
                $('#button-submit').button('loading');
                block_section('.quick-checkout-wrapper');
            },
            success: function(json) {
                if (json['redirect']) {
                    location = json['redirect'];
                    return;
                }

                if (json['error']) {
                    $('#button-submit').button('reset');

                    if (json['error']['shipping_address']) {
                        $.each(json['error']['shipping_address'], function (key, value) {
                            if (key === 'country' || key === 'zone' || key === 'city' || key === 'county') {
                                var control = $('#shipping-new [name="shipping_' + key + '_id"]');
                            } else if (key.indexOf('custom_field') === 0) {
                                var control = $('#shipping-new [name="shipping_custom_field[' + key.replace('custom_field', '') + ']"]');
                            } else {
                                var control = $('#shipping-new [name="shipping_' + key + '"]');
                            }

                            control.closest('.form-group').addClass('has-error');
                            control.closest('.form-group').append('<div class="text-danger">' + value + '</div>');
                        });
                    }

                    {% set types = ['payment', 'shipping']%}
                    {% for type in types %}
                    if (json['error']['{{ type }}_method'] && json['error']['{{ type }}_method']['warning']) {
                        $('#{{ type }}-method-section').append('<div class="alert alert-danger">' + json['error']['{{ type }}_method']['warning'] + '</div>')
                    }
                    {% endfor %}

                    if (json['error']['agree']) {
                        if (json['error']['agree']['terms']) {
                            var control = $('#agree-section [name="terms"]');
                            control.closest('label').addClass('has-error');
                            control.closest('label').after('<div class="text-danger">' + json['error']['agree']['terms'] + '</div>');
                        }
                    }
                } else {
                    // Order created go to payment connect page
                    location = 'index.php?route=checkout/checkout/connect';
                }
            },
            error: function(xhr, ajaxOptions, thrownError) {
                alert(thrownError);
                $('#button-submit').button('reset');
            },
            complete: function () {
                unblock_section('.quick-checkout-wrapper');
            }
        });
    }

    function reload_right_section_html() {
        $.ajax({
            url: 'index.php?route=checkout/checkout/reload',
            dataType: 'html',
            beforeSend: function () {
                block_section('.right-section-wrapper');
            },
            success: function(html) {
                $('.right-section-wrapper').replaceWith(html);
            },
            error: function(xhr, ajaxOptions, thrownError) {
                alert(thrownError);
            },
            complete: function () {
            }
        });
    }

    function block_section(section_id) {
        if (!$(section_id).children('.loading-mask').length) {
            $(section_id).append('<div class="loading-mask"></div>');
        }
    }

    function unblock_section(section_id) {
        $(section_id).children('.loading-mask').remove();
    }
    //--></script>
